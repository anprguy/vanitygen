# GPU Counter Implementation - Separate "Keys Generated" and "Keys Checked"

## Overview

This implementation adds separate counter tracking for GPU-only mode in the Bitcoin vanity address generator. The GUI now displays two distinct counters:

1. **Keys Generated**: Total number of private keys generated by the GPU
2. **Keys Checked**: Number of keys checked against the funded address list

## What Was Changed

### 1. GPU Generator (`vanitygen_py/gpu_generator.py`)

#### Added Counters
```python
class GPUGenerator:
    def __init__(self, ...):
        # Separate counters for GPU-only mode
        self.keys_generated = 0  # Total keys generated on GPU
        self.keys_checked = 0     # Keys checked against funded list
```

#### Updated `get_stats()` Method
Changed from returning a simple integer to returning a dictionary with all stats:

```python
def get_stats(self):
    with self.stats_lock:
        count = self.stats_counter
        self.stats_counter = 0
        generated = self.keys_generated
        checked = self.keys_checked
    return {
        'total': count,  # Legacy counter for backward compatibility
        'keys_generated': generated,
        'keys_checked': checked
    }
```

#### Updated Search Loops
All search loops now increment both counters:

- **`_search_loop_gpu_only()`**: GPU-only mode
  ```python
  with self.stats_lock:
      self.stats_counter += self.batch_size
      self.keys_generated += self.batch_size
      self.keys_checked += self.batch_size  # Every key is checked
  ```

- **`_search_loop_gpu_only_exact()`**: GPU-only with exact address matching
  ```python
  with self.stats_lock:
      self.stats_counter += self.batch_size
      self.keys_generated += self.batch_size
      self.keys_checked += self.batch_size  # Every key is checked
  ```

- **`_search_loop_with_balance_check()`**: GPU balance checking mode
  ```python
  with self.stats_lock:
      self.stats_counter += self.batch_size
      self.keys_generated += self.batch_size
      self.keys_checked += self.batch_size  # Every key is checked
  ```

- **`_search_loop()`**: CPU-assisted mode
  ```python
  with self.stats_lock:
      self.stats_counter += self.batch_size
      self.keys_generated += self.batch_size
      # keys_checked stays at 0 (no balance checking in this mode)
  ```

#### Reset Counters on Start
```python
def start(self):
    # ...
    self.stats_counter = 0
    self.keys_generated = 0
    self.keys_checked = 0
    # ...
```

### 2. GUI (`vanitygen_py/gui.py`)

#### Updated Signal
Changed `stats_updated` signal to include both counters:
```python
class GeneratorThread(QThread):
    stats_updated = Signal(int, int, float)  # keys_generated, keys_checked, speed
```

#### Updated Thread Run Loop
Modified to emit both counters:
```python
def run(self):
    # ...
    stats = self.generator.get_stats()
    # Handle both old (int) and new (dict) formats
    if isinstance(stats, dict):
        new_keys = stats.get('total', 0)
        keys_generated_total = stats.get('keys_generated', 0)
        keys_checked_total = stats.get('keys_checked', 0)
    else:
        new_keys = stats
        keys_generated_total += new_keys
        keys_checked_total += new_keys
    # ...
    self.stats_updated.emit(keys_generated_total, keys_checked_total, speed)
```

#### Updated Stats Display
Changed label to show both counters:
```python
def update_stats(self, keys_generated, keys_checked, speed):
    self.stats_label.setText(
        f"Keys Generated: {keys_generated:,} | "
        f"Keys Checked: {keys_checked:,} | "
        f"Speed: {speed:.2f} keys/s"
    )
```

#### Updated Tooltip
Added helpful tooltip explaining the counters:
```python
self.stats_label.setToolTip(
    "Keys Generated: Total number of private keys generated by GPU\n"
    "Keys Checked: Number of keys checked against funded address list\n"
    "(In GPU-only mode with balance checking, both counters will be equal)\n"
    "Speed: Keys generated per second\n\n"
    "See Settings tab 'Matches Found' for the count of matching addresses."
)
```

## How It Works

### GPU-Only Mode
In GPU-only mode with balance checking:
1. GPU generates a batch of private keys
2. GPU computes addresses from private keys (EC operations)
3. GPU checks each address against the funded address list
4. Both `keys_generated` and `keys_checked` increment by batch size
5. **Result**: Both counters are equal (every generated key is checked)

### GPU-Only Mode WITHOUT Balance Checking
If no balance checker is loaded:
1. GPU generates a batch of private keys
2. GPU computes addresses from private keys
3. GPU checks addresses against prefix only (vanity search)
4. `keys_generated` increments, `keys_checked` increments
5. **Result**: Both counters are equal

### CPU-Assisted Mode
In CPU-assisted mode (GPU for keys, CPU for addresses):
1. GPU generates private keys → `keys_generated` increments
2. CPU computes addresses and checks prefix
3. No balance checking in this mode → `keys_checked` stays at 0
4. **Result**: `keys_generated` > `keys_checked`

## Testing

A comprehensive test suite was added: `test_gpu_counters.py`

Run tests:
```bash
python test_gpu_counters.py
```

Tests verify:
1. Both counters increment correctly
2. Counters match in GPU-only mode (as expected)
3. Stats are returned in correct format (dict)
4. GUI can handle both old (int) and new (dict) formats

## GUI Display

The Progress tab now shows:
```
Keys Generated: 1,000,000 | Keys Checked: 1,000,000 | Speed: 50,000 keys/s
```

- **Keys Generated**: Total keys generated on GPU (fast!)
- **Keys Checked**: Keys checked against funded list (GPU does this too!)
- **Speed**: Keys/second (measures generation speed)

## Backward Compatibility

The implementation maintains backward compatibility:
- `get_stats()` returns a dict with `'total'` key for old code
- GUI handles both int and dict return values
- CPUGenerator still returns int (GUI adapted to handle both)
- HybridGenerator uses dict format (compatible)

## Future Enhancements

Possible improvements:
1. **CPU Sampling Counter**: Add `keys_verified_by_cpu` to track EC verification sampling
2. **Match Counter**: Track number of addresses that matched criteria (separate from keys checked)
3. **Performance Metrics**: Add GPU utilization, memory usage, etc.
4. **Configurable Checking**: Allow user to set sampling rate (check every N keys instead of all)

## Known Behaviors

### In GPU-Only Mode With Balance Checking
- Both counters increment equally (every key is checked)
- This is expected and correct behavior
- GPU checks ALL keys against the funded list

### In CPU-Assisted Mode
- `keys_generated` increments (GPU generates keys)
- `keys_checked` stays at 0 (no balance checking)
- This is expected - balance checking only works in GPU-only mode

### EC Verification Sampling
- Separate from the main counters
- Controlled by `ec_check_interval` parameter
- Results shown in "EC Checks" tab
- Does NOT affect `keys_checked` counter (that's for balance checking)

## Summary

This implementation provides transparent visibility into GPU operations:
- Users can see how many keys have been generated
- Users can see how many keys have been checked against the funded list
- In GPU-only mode, both happen on GPU (very fast!)
- GUI clearly displays both metrics
- Backward compatible with existing code
